# postgres_configuration

**install_start.yml**

В данном файле происходит установка всех пакетов и зависимостей, а также конфигурирование сервисов для работы и подключения к PostgreSQL. Запуск сервиса PostgreSQL и инициализация базы данных

**test_conn.yml**

С помощью этого playbook создается пользователь и база данных, а также выдаются права пользователю для работы с базой. Необходимо для проверки подключения к базе удаленно

**Для запуска необходимо:**

1. Выдать права на выполнение файлу conf.sh
2. Настроить файл inventory
3. Запустить скрит conf.sh

# Метрики

**Используемые технологии и инструменты:**
1. postgres_exporter - инструмент для мониторинга метрик базы данных PostgreSQL
2. Prometheus - хранение метрик
3. Grafana - визуализация метрик

**Плюсы:** 
1. Много доступных метрик
2. Возможность писать свои метрики и свои dashboard
3. Поддержка мониторинга нескольких баз данных и нескольких экземпляров PostgreSQL

**Минусы:**
1. Отсутствие авторизации
2. Передача данных, только, по протоколу HTTP
3. Не кэширует метрики. Таким образом, например при сетевой недоступности агента данные за период недоступности, в Prometheus, не поступят

**Метрики:**
1. pg_postmaster_start_time_seconds - эта метрика показывает, когда был запущен основной процесс PostgreSQL, alert если резко упало (значит PostgreSQL был перезапущен)
2. sum(pg_stat_database_xact_rollback)/sum(pg_stat_database_xact_commit)*100 - отношение количества транзакций, которые были отменены, к количеству транзакций, которые были выполнены, alert при значении больше 50%
3. ((sum (pg_locks_count)) / (pg_settings_max_locks_per_transaction * pg_settings_max_connections)) * 100 - отношение количества блокировок к произведению максимального числа блокировок в одной транзакции на количество подключений, alert при достижении 30%
4. (sum(pg_stat_activity_count) / sum(pg_settings_max_connections)) * 100 - отношение количества текущих подключений, к количеству максимальных подключений, alert при достижении 80%
5. sum(rate(pg_stat_statements_calls[1m])) - количество запросов в минуту, alert при резком увеличении в 2 раза
6. sum(rate(pg_stat_statements_mean_time_seconds[1m])) - среднее время выполнения запроса в милисикундах за минуту
7. pg_database_size_bytes - размер базы данных, alert при достижении 80% свободного пространства
8. pg_stat_bgwriter_checkpoint_write_time - общее время, затраченное на этап обработки контрольной точки, в котором файлы записываются на диск. Позволяет оценить производительность записи данных в базе данных
9. pg_replication_lag - время между записью данных в основную базу и их копированием в резервные базы, alert при показателе больше 10 секунд
10. (rate(pg_stat_database_blks_hit) /((rate(pg_stat_database_blks_hit) + rate(pg_stat_database_blks_read)))) * 100 - процент чтения из кэша, alert при значении меньше 80%
   
# Kerberos

**Требования**

1. Подразумевается, что обмен сообщений осуществляется с доверенных устройств, но в открытой недоверенной среде.
2. Информация о пользователях и их секретах должна хранится в выделенном месте.
3. Должна поддерживаться технология единого входа.
4. Успешное окончание работы протокола должно означать успешную взаимную аутентификацию сторон.
5. В результате работы протокола между клиентом и сервисом должен быть сформирован секретный сессионный ключ.

**Основные понятия**

Kerberos – протокол аутентификации, но при этом предусматривающий возможность транспортировки информации необходимой для авторизации.

Принципал (Principal) – это строка, полностью идентифицирующая участника протокола Kerberos.

Область действия (Realm) – совокупность клиентов, серверов и сервисов, участвующих в протоколе Kerberos.

Центр распределения ключей (Key Distribution Center, KDC) является доверенным центром аутентификации для всех участников протокола Kerberos в рамках определенной области действия.

**Принципал**

Service Principal Name(SPN): форма - service-name/host[:port]@REALM Пример: для сервиса ftp, работающего на хосте с именем fileserver.example.com в области @EXAMPLE.COM, имя принципала сервиса будет ftp/fileserver.example.com@EXAMPLE.COM.

User Principal Name(UPN): форма - principal-name[/instance-name]@REALM Пример: имя пользователя - Ivan, а область действия - DOMAIN.LOCAL, то полный принципал будет Ivan@DOMAIN.LOCAL.

**Компоненты KDC**

База данных Kerberos, предназначенная для хранения информации о всех принципалах и их секретах.

Сервер аутентификации (Authentication Server, AS), обрабатывающий запросы на аутентификацию клиентов к области действия протокола Kerberos.

Сервер выдачи разрешений (Ticket Granting Server, TGS), обрабатывающий запросы на аутентификацию к определенному сервису, функционирующего в составе указанной области действия.

**Алгоритм дествия**

1. Клиент отправляет запрос на аутентификацию к области действия. (сообщение KRB_AS_REQ)
2. Сервер аутентификации проверяет подлинность Клиента с использованием Базы данных Kerberos. 
3. Сервер выдает Клиенту разрешение (TGT - Ticket Granting Ticket) на получение отдельных разрешений (ST - Service Ticket), требующимся для доступа к сервисам, входящим в область действия. (сообщение KRB_AS_REP)
4. С использованием полученного на шаге №3 разрешения (TGT) Клиент запрашивает разрешение на доступ к Сервису А («ST для А»). (сообщение KRB_TGS_REQ)
5. Сервер выдачи разрешений проверяет TGT и выдает Клиенту ST для доступа к сервису А. (сообщение KRB_TGS_REP)
6. Клиент с использованием «ST для А» запрашивает у Сервиса А доступ к его ресурсам. (сообщение KRB_AP_REQ)
7. Сервис А проверяет «ST для А» и предоставляет Клиенту доступ к своим ресурсам. При необходимости сервис также проходит аутентификацию перед клиентом. (сообщение KRB_AP_REP)






